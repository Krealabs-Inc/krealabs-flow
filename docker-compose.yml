services:
  # =============================================
  # Application Next.js
  # Profil "app" — non démarré par défaut.
  # Dev  : docker compose up -d          (infra seule + pnpm dev en local)
  # Prod : docker compose --profile app up -d --build
  # =============================================
  app:
    profiles: ["app"]
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_STACK_PROJECT_ID: ${NEXT_PUBLIC_STACK_PROJECT_ID}
        NEXT_PUBLIC_STACK_PUBLISHABLE_CLIENT_KEY: ${NEXT_PUBLIC_STACK_PUBLISHABLE_CLIENT_KEY}
        NEXT_PUBLIC_STACK_API_URL: ${NEXT_PUBLIC_STACK_API_URL:-http://localhost:8102}
        STACK_SECRET_SERVER_KEY: ${STACK_SECRET_SERVER_KEY}
    ports:
      - "${APP_PORT:-3000}:3000"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-krealabs}:${POSTGRES_PASSWORD:-krealabs}@supabase-db:5432/${POSTGRES_DB:-krealabs_flow}
      - NEXT_PUBLIC_STACK_PROJECT_ID=${NEXT_PUBLIC_STACK_PROJECT_ID}
      - NEXT_PUBLIC_STACK_PUBLISHABLE_CLIENT_KEY=${NEXT_PUBLIC_STACK_PUBLISHABLE_CLIENT_KEY}
      - STACK_SECRET_SERVER_KEY=${STACK_SECRET_SERVER_KEY}
      - NEXT_PUBLIC_STACK_API_URL=${NEXT_PUBLIC_STACK_API_URL:-http://localhost:8102}
      # URL interne Docker pour les appels serveur → Stack Auth
      - STACK_API_URL=http://stack-auth:8102
      - PDF_STORAGE_PATH=/app/storage/pdf
    volumes:
      - pdf_storage:/app/storage
    depends_on:
      supabase-db:
        condition: service_healthy
      stack-auth:
        condition: service_started
    networks:
      - internal
    restart: unless-stopped

  # =============================================
  # PostgreSQL
  # =============================================
  supabase-db:
    image: postgres:17-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-krealabs}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-krealabs}
      POSTGRES_DB: ${POSTGRES_DB:-krealabs_flow}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/init:/docker-entrypoint-initdb.d
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-krealabs} -d ${POSTGRES_DB:-krealabs_flow}"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      internal:
        aliases:
          - db
    restart: unless-stopped

  # =============================================
  # Supabase DB Init — crée les rôles PostgreSQL
  # nécessaires pour PostgREST, GoTrue et Studio.
  # S'exécute à chaque démarrage (idempotent).
  # =============================================
  supabase-db-init:
    image: postgres:17-alpine
    depends_on:
      supabase-db:
        condition: service_healthy
    environment:
      PGPASSWORD: ${POSTGRES_PASSWORD:-krealabs}
    volumes:
      - ./docker/supabase/init-roles.sql:/init-roles.sql:ro
    command: >
      psql
        -h supabase-db
        -U ${POSTGRES_USER:-krealabs}
        -d ${POSTGRES_DB:-krealabs_flow}
        -f /init-roles.sql
    networks:
      - internal
    restart: on-failure

  # =============================================
  # postgres-meta — API de métadonnées PostgreSQL
  # Utilisé par Studio pour explorer le schéma,
  # lancer des requêtes SQL, gérer les tables.
  # Accès direct (dev) : http://localhost:5555
  # =============================================
  supabase-meta:
    image: supabase/postgres-meta:v0.95.2
    depends_on:
      supabase-db-init:
        condition: service_completed_successfully
    environment:
      PG_META_PORT: 8080
      PG_META_DB_HOST: supabase-db
      PG_META_DB_PORT: 5432
      PG_META_DB_NAME: ${POSTGRES_DB:-krealabs_flow}
      PG_META_DB_USER: ${POSTGRES_USER:-krealabs}
      PG_META_DB_PASSWORD: ${POSTGRES_PASSWORD:-krealabs}
      PG_META_DB_SSL_MODE: disable
    ports:
      - "${META_PORT:-5555}:8080"
    networks:
      - internal
    restart: unless-stopped

  # =============================================
  # PostgREST — API REST auto-générée
  # Utilisée par Studio pour lire/écrire les données
  # dans les tables directement depuis l'UI.
  # =============================================
  supabase-rest:
    image: postgrest/postgrest:v14.5
    depends_on:
      supabase-db-init:
        condition: service_completed_successfully
    environment:
      PGRST_DB_URI: postgresql://authenticator:supabase-authenticator-dev@supabase-db:5432/${POSTGRES_DB:-krealabs_flow}
      PGRST_DB_SCHEMAS: ${PGRST_DB_SCHEMAS:-public}
      PGRST_DB_ANON_ROLE: anon
      PGRST_JWT_SECRET: ${SUPABASE_JWT_SECRET:-super-secret-jwt-token-with-at-least-32-characters-long}
      PGRST_DB_USE_LEGACY_GUCS: "false"
      PGRST_APP_SETTINGS_JWT_SECRET: ${SUPABASE_JWT_SECRET:-super-secret-jwt-token-with-at-least-32-characters-long}
      PGRST_APP_SETTINGS_JWT_EXP: ${JWT_EXPIRY:-3600}
    networks:
      - internal
    restart: unless-stopped

  # =============================================
  # GoTrue — service d'authentification Supabase
  # Requis par Studio pour la gestion des sessions
  # et l'onglet "Authentication".
  # =============================================
  supabase-auth:
    image: supabase/gotrue:v2.187.0
    depends_on:
      supabase-db-init:
        condition: service_completed_successfully
    environment:
      GOTRUE_API_HOST: 0.0.0.0
      GOTRUE_API_PORT: 9999
      API_EXTERNAL_URL: ${API_EXTERNAL_URL:-http://localhost:8000}
      GOTRUE_DB_DRIVER: postgres
      # Utilise le user principal (superuser) pour que GoTrue puisse créer
      # ses tables de migration dans public + le schéma auth sans erreurs de permissions.
      GOTRUE_DB_DATABASE_URL: postgresql://${POSTGRES_USER:-krealabs}:${POSTGRES_PASSWORD:-krealabs}@supabase-db:5432/${POSTGRES_DB:-krealabs_flow}
      GOTRUE_SITE_URL: ${SITE_URL:-http://localhost:3001}
      GOTRUE_URI_ALLOW_LIST: ${ADDITIONAL_REDIRECT_URLS:-}
      GOTRUE_DISABLE_SIGNUP: ${DISABLE_SIGNUP:-false}
      GOTRUE_JWT_ADMIN_ROLES: service_role
      GOTRUE_JWT_AUD: authenticated
      GOTRUE_JWT_DEFAULT_GROUP_NAME: authenticated
      GOTRUE_JWT_EXP: ${JWT_EXPIRY:-3600}
      GOTRUE_JWT_SECRET: ${SUPABASE_JWT_SECRET:-super-secret-jwt-token-with-at-least-32-characters-long}
      GOTRUE_EXTERNAL_EMAIL_ENABLED: "true"
      GOTRUE_EXTERNAL_ANONYMOUS_USERS_ENABLED: "false"
      GOTRUE_MAILER_AUTOCONFIRM: ${MAILER_AUTOCONFIRM:-true}
      GOTRUE_SMTP_ADMIN_EMAIL: ${SMTP_ADMIN_EMAIL:-admin@krealabs.local}
      GOTRUE_SMTP_HOST: ${SMTP_HOST:-mailpit}
      GOTRUE_SMTP_PORT: ${SMTP_PORT:-1025}
      GOTRUE_SMTP_USER: ${SMTP_USER:-}
      GOTRUE_SMTP_PASS: ${SMTP_PASS:-}
      GOTRUE_SMTP_SENDER_NAME: ${SMTP_SENDER_NAME:-KreaLabs Flow}
      GOTRUE_MAILER_URLPATHS_INVITE: ${MAILER_URLPATHS_INVITE:-/auth/v1/verify}
      GOTRUE_MAILER_URLPATHS_CONFIRMATION: ${MAILER_URLPATHS_CONFIRMATION:-/auth/v1/verify}
      GOTRUE_MAILER_URLPATHS_RECOVERY: ${MAILER_URLPATHS_RECOVERY:-/auth/v1/verify}
      GOTRUE_MAILER_URLPATHS_EMAIL_CHANGE: ${MAILER_URLPATHS_EMAIL_CHANGE:-/auth/v1/verify}
      GOTRUE_EXTERNAL_PHONE_ENABLED: "false"
      GOTRUE_SMS_AUTOCONFIRM: "false"
    networks:
      - internal
    restart: unless-stopped

  # =============================================
  # Kong — API Gateway Supabase
  # Route les requêtes de Studio vers :
  #   /auth/v1/  → GoTrue
  #   /rest/v1/  → PostgREST
  #   /pg/       → postgres-meta
  # API interne : http://supabase-kong:8000
  # Port hôte   : http://localhost:8000
  # =============================================
  supabase-kong:
    image: kong:2.8.1
    # Pas d'entrypoint custom — on monte kong.yml directement à l'emplacement attendu.
    # Le trick eval/echo de Supabase strip les guillemets YAML ("1.1" → 1.1)
    # ce qui casse le parsing. Le kong.yml est simplifié (pas de key-auth) donc
    # aucune substitution de variables n'est nécessaire.
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /home/kong/kong.yml
      KONG_DNS_ORDER: LAST,A,CNAME
      KONG_PLUGINS: request-transformer,cors,key-auth,acl,basic-auth
      KONG_NGINX_PROXY_PROXY_BUFFER_SIZE: 160k
      KONG_NGINX_PROXY_PROXY_BUFFERS: 64 160k
    volumes:
      - ./docker/supabase/kong.yml:/home/kong/kong.yml:ro
    ports:
      - "${KONG_HTTP_PORT:-8000}:8000"
      - "${KONG_HTTPS_PORT:-8443}:8443"
    depends_on:
      supabase-meta:
        condition: service_started
      supabase-rest:
        condition: service_started
      supabase-auth:
        condition: service_started
    networks:
      - internal
    restart: unless-stopped

  # =============================================
  # Supabase Studio — Interface graphique DB
  # Table editor, SQL editor, explorateur schéma.
  # Accessible sur http://localhost:3001
  # =============================================
  supabase-studio:
    image: supabase/studio:2026.02.16-sha-26c615c
    depends_on:
      supabase-kong:
        condition: service_started
    healthcheck:
      # /api/profile n'existe pas dans Studio v2026 — on check le root (307 redirect = OK)
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:3000/', (r) => { if (r.statusCode < 500) process.exit(0); else process.exit(1); }).on('error', () => process.exit(1))"
        ]
      timeout: 10s
      interval: 10s
      retries: 5
      start_period: 30s
    environment:
      # postgres-meta via Kong
      STUDIO_PG_META_URL: http://supabase-kong:8000/pg
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-krealabs}

      # Kong gateway (interne + externe)
      SUPABASE_URL: http://supabase-kong:8000
      SUPABASE_PUBLIC_URL: ${SUPABASE_PUBLIC_URL:-http://localhost:8000}

      # JWT keys (doivent correspondre à ceux de Kong/GoTrue/PostgREST)
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRFA0NiK7kyqAMb1MQi4wYKFWAV3YX5HFy7tEFdM_Gs}
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hj04zWl196z2-SBc0}
      AUTH_JWT_SECRET: ${SUPABASE_JWT_SECRET:-super-secret-jwt-token-with-at-least-32-characters-long}

      # Projet par défaut
      DEFAULT_ORGANIZATION_NAME: ${STUDIO_DEFAULT_ORGANIZATION:-KreaLabs}
      DEFAULT_PROJECT_NAME: ${STUDIO_DEFAULT_PROJECT:-krealabs-flow}

      # Désactiver les logs analytics (pas de service logflare dans notre stack)
      NEXT_PUBLIC_ENABLE_LOGS: "false"
      NEXT_ANALYTICS_BACKEND_PROVIDER: postgres
      # Requis par Studio v2026+ pour la gestion des Edge Functions (dossier local)
      EDGE_FUNCTIONS_MANAGEMENT_FOLDER: /app/edge-functions
      # Next.js 16 ne bind plus sur 127.0.0.1 par défaut dans Docker ;
      # forcer 0.0.0.0 pour que le healthcheck (localhost:3000) fonctionne.
      HOSTNAME: 0.0.0.0
    volumes:
      - studio_edge_functions:/app/edge-functions
    ports:
      - "${STUDIO_PORT:-3001}:3000"
    networks:
      - internal
    restart: unless-stopped

  # =============================================
  # ClickHouse (analytics pour Stack Auth)
  # =============================================
  clickhouse:
    image: clickhouse/clickhouse-server:latest
    environment:
      CLICKHOUSE_DB: analytics
      CLICKHOUSE_USER: stackframe
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-clickhouse-krealabs}
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    volumes:
      - clickhouse_data:/var/lib/clickhouse
    networks:
      - internal
    restart: unless-stopped

  # =============================================
  # MinIO — stockage objet S3-compatible
  # Requis par Stack Auth pour les session replays
  # Console : http://localhost:9001  (minioadmin / minioadmin)
  # =============================================
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - minio_data:/data
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - internal
    restart: unless-stopped

  # Crée les buckets MinIO au démarrage (idempotent)
  minio-init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
        mc alias set local http://minio:9000 ${MINIO_ROOT_USER:-minioadmin} ${MINIO_ROOT_PASSWORD:-minioadmin};
        mc mb --ignore-existing local/stack-auth;
        mc mb --ignore-existing local/stack-auth-private;
        exit 0;
      "
    networks:
      - internal

  # =============================================
  # Stack Auth (authentification)
  # =============================================
  stack-auth:
    image: stackauth/server:latest
    environment:
      - STACK_DATABASE_CONNECTION_STRING=postgresql://${POSTGRES_USER:-krealabs}:${POSTGRES_PASSWORD:-krealabs}@supabase-db:5432/stack_auth
      - STACK_SERVER_SECRET=${STACK_SERVER_SECRET:-change-me-in-production}
      - STACK_CLICKHOUSE_URL=http://clickhouse:8123
      - STACK_CLICKHOUSE_ADMIN_PASSWORD=${CLICKHOUSE_PASSWORD:-clickhouse-krealabs}
      - STACK_CLICKHOUSE_EXTERNAL_PASSWORD=${CLICKHOUSE_PASSWORD:-clickhouse-krealabs}
      - NEXT_PUBLIC_STACK_API_URL=http://localhost:8102
      - NEXT_PUBLIC_BROWSER_STACK_API_URL=http://localhost:8102
      - NEXT_PUBLIC_STACK_DASHBOARD_URL=http://localhost:8101
      - STACK_SEED_INTERNAL_PROJECT_ALLOW_LOCALHOST=true
      - STACK_SEED_INTERNAL_PROJECT_SIGN_UP_ENABLED=true
      - STACK_RUN_MIGRATIONS=true
      - STACK_RUN_SEED_SCRIPT=true
      - STACK_FREESTYLE_API_KEY=
      # Stockage S3 (MinIO) — noms exacts lus par stackauth/server
      - STACK_S3_ACCESS_KEY_ID=${MINIO_ROOT_USER:-minioadmin}
      - STACK_S3_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - STACK_S3_ENDPOINT=http://minio:9000
      - STACK_S3_PUBLIC_ENDPOINT=http://localhost:9000
      - STACK_S3_REGION=us-east-1
      - STACK_S3_BUCKET=stack-auth
      - STACK_S3_PRIVATE_BUCKET=stack-auth-private
    ports:
      - "${STACK_DASHBOARD_PORT:-8101}:8101"
      - "${STACK_API_PORT:-8102}:8102"
    depends_on:
      supabase-db:
        condition: service_healthy
      clickhouse:
        condition: service_started
      minio:
        condition: service_healthy
    networks:
      - internal
    restart: unless-stopped

  # =============================================
  # Mailpit — SMTP local de dev
  # Console emails : http://localhost:8025
  # SMTP interne    : mailpit:1025
  #
  # Après démarrage, configurer le SMTP Stack Auth :
  #   http://localhost:8101 → Project Settings → Emails → Custom SMTP
  #   Host: mailpit  Port: 1025  (sans auth, sans TLS)
  # =============================================
  mailpit:
    image: axllent/mailpit:latest
    ports:
      - "${MAILPIT_UI_PORT:-8025}:8025"   # Web UI
      - "${MAILPIT_SMTP_PORT:-1025}:1025" # SMTP
    networks:
      - internal
    restart: unless-stopped

  # =============================================
  # Redis (cache, sessions, rate-limiting)
  # =============================================
  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    networks:
      - internal
    restart: unless-stopped

volumes:
  postgres_data:
  pdf_storage:
  redis_data:
  clickhouse_data:
  minio_data:
  studio_edge_functions:

networks:
  internal:
    driver: bridge
